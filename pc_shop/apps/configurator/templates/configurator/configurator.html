{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Конфигуратор ПК | PC Shop{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'configurator/css/configurator.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="configurator-container">
  <!-- Верхняя панель управления -->
  <div class="control-panel mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Создание сборки</h3>
      <div class="d-flex gap-3">
        <button class="btn btn-outline-primary" id="toggleCompatibilityView">
          <i class="fas fa-plug-circle-check"></i> Показать совместимость
        </button>
        <button class="btn btn-success" id="saveBuildBtn">
          <i class="fas fa-save"></i> Сохранить сборку
        </button>
      </div>
    </div>
  </div>

  <!-- Основная сетка -->
  <div class="row g-4">
    <!-- Визуализация сборки -->
    <div class="col-12 col-lg-7">
      <div class="build-visualization shadow-sm rounded-3 p-4">
        <h5 class="mb-4">Состав сборки</h5>

        <div class="component-slots" id="buildSlots">
          <!-- Слоты будут динамически генерироваться -->
        </div>

        <!-- Итоговая информация -->
        <div class="total-info mt-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Общая стоимость:</span>
            <span class="total-price">0 ₽</span>
          </div>
          <div class="progress" style="height: 25px;">
            <div class="progress-bar" role="progressbar" style="width: 0%"
                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              Совместимость: 0%
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Боковая панель выбора -->
    <div class="col-12 col-lg-5">
      <div class="component-selector shadow-sm rounded-3">
        <div class="selector-header bg-light p-3 rounded-top">
          <div class="d-flex align-items-center gap-2">
            <i class="fas fa-puzzle-piece"></i>
            <select class="form-select form-select-sm" id="componentCategory">
              {% for category in categories %}
                <option value="{{ category.slug }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="selector-body p-3">
          <!-- Список компонентов -->
          <div id="componentList" class="component-list mb-3"
               style="max-height: 500px; overflow-y: auto;">
            <!-- Компоненты подгружаются через AJAX -->
          </div>

          <!-- Фильтры -->
          <div class="filter-section mb-3">
            <div class="input-group">
              <input type="text" class="form-control" id="componentSearch"
                     placeholder="Поиск компонента...">
              <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-filter"></i>
              </button>
            </div>
          </div>

          <!-- Детали компонента -->
          <div id="componentDetails" class="component-details d-none">
            <h6 class="mb-2">Характеристики:</h6>
            <ul class="list-unstyled" id="componentSpecs"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно сохранения -->
  <div class="modal fade" id="saveBuildModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Сохранить сборку</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="saveBuildForm">
            <div class="mb-3">
              <label for="buildName" class="form-label">Название</label>
              <input type="text" class="form-control" id="buildName" required>
            </div>
            <div class="mb-3">
              <label for="buildDescription" class="form-label">Описание</label>
              <textarea class="form-control" id="buildDescription" rows="3"></textarea>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="isPublic">
              <label class="form-check-label" for="isPublic">Публичная сборка</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="confirmSaveBtn">Сохранить</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/configurator.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Инициализация компонентов
  const configurator = new Configurator({
    categories: {{ categories|safe }},
    componentTypes: {{ component_types|safe }},
    compatibilityCheckUrl: "{% url 'api_check_compatibility' %}",
    saveBuildUrl: "{% url 'api_save_build' %}",
    componentListUrl: "{% url 'api_components' 'CATEGORY_SLUG' %}"
  });

  // Обработчики сохранения
  document.getElementById('saveBuildBtn').addEventListener('click', () => {
    configurator.showSaveModal();
  });

  document.getElementById('confirmSaveBtn').addEventListener('click', () => {
    configurator.saveBuild();
  });
});
</script>
{% endblock %}