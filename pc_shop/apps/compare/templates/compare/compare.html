{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block css %}
<link rel="stylesheet" href="{% static 'compare/css/compare.css' %}">
<style>
  .compare-table {
    min-width: 800px;
    border-collapse: collapse;
    margin: 2rem 0;
  }
  .compare-table th, .compare-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
  }
  .product-header {
    position: relative;
  }
  .remove-btn {
    position: absolute;
    top: 0;
    right: 0;
    background: #ff4444;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 0 0 0 5px;
  }
  .attr-name {
    font-weight: bold;
    background: #f8f9fa;
  }
  .group-row td {
    background: #e9ecef;
    font-weight: bold;
  }
  .product-image {
    max-width: 150px;
    height: auto;
    display: block;
    margin: 0 auto;
  }
  .max-reached {
    background: #ffeeba;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block title %}Сравнение товаров{% endblock %}

{% block content %}
<div class="compare-container">
  <h1 class="compare-heading">Сравнение товаров</h1>

  {% if comparison.products.exists %}
    <!-- Блок уведомления о лимите -->
    {% if comparison.products.count >= comparison.MAX_PRODUCTS %}
      <div class="max-reached">
        Достигнут максимальный лимит в {{ comparison.MAX_PRODUCTS }} товара(ов)
      </div>
    {% endif %}

    <div class="table-responsive">
      <table class="compare-table">
        <thead>
          <tr>
            <th class="compare-header">Характеристика</th>
            {% for product in comparison.products.all %}
              <th class="product-header">
                <div class="product-info">
                  {% if product.main_image %}
                    <img src="{{ product.main_image.get_thumbnail_url }}" class="product-image">
                  {% endif %}
                  <span>{{ product.name }}</span>
                  <button
                    class="remove-btn"
                    onclick="removeProduct({{ product.id }})"
                  >×</button>
                </div>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for (group, attr_name), values in attributes_matrix.items %}
            <tr class="group-row">
              <td colspan="{{ comparison.products.count|add:1 }}">{{ group }}</td>
            </tr>
            <tr class="attr-row">
              <td class="attr-name">{{ attr_name }}</td>
              {% for product in comparison.products.all %}
                <td class="attr-value">{{ values|get_item:product.id|default:"—" }}</td>
              {% endfor %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ comparison.products.count|add:1 }}">Нет характеристик для сравнения</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Скрипт для AJAX-удаления -->
    <script>
      function removeProduct(productId) {
        if (confirm('Удалить товар из сравнения?')) {
          fetch("{% url 'compare:remove' 0 %}".replace('0', productId), {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.reload();
            } else {
              alert(data.message);
            }
          });
        }
      }
    </script>

  {% else %}
    <div class="empty-compare">
      <p>Нет товаров для сравнения.</p>
      <a href="{% url 'product_list' %}" class="btn btn-primary">Перейти в каталог</a>
    </div>
  {% endif %}
</div>
{% endblock %}