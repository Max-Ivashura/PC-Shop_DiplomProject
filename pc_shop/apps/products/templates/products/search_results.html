{% extends 'base.html' %}
{% load static %}
{% load url_helpers %}
{% load cache %}

{% block title %}
    {% if query %}{{ query }} - {% endif %}Результаты поиска
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'products/css/product_list.css' %}">
    <style>
        .search-highlight {
            background-color: #ffff00;
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="search-results-container" itemscope itemtype="http://schema.org/SearchResultsPage">
        <div class="container">
            <div class="search-stats mb-4">
                <h1 class="h3">Результаты поиска: "{{ query }}"</h1>
                <p class="text-muted mb-0">
                    Найдено: <strong>{{ products.count }}</strong> товаров
                    {% if search_time %}(за {{ search_time|floatformat:2 }} сек){% endif %}
                </p>
            </div>

            <!-- Блок сортировки -->
            <div class="d-flex justify-content-end mb-4">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                        Сортировать:
                        <span id="active-sort-label">
                            {% if request.GET.sort == 'price_asc' %}
                                по возрастанию цены
                            {% elif request.GET.sort == 'price_desc' %}
                                по убыванию цены
                            {% elif request.GET.sort == 'newest' %}
                                новинки
                            {% else %}
                                по умолчанию
                            {% endif %}
                        </span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item {% if request.GET.sort == 'price_asc' %}active{% endif %}"
                               href="?{% url_replace q=query sort='price_asc' %}">
                                Цена: по возрастанию
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item {% if request.GET.sort == 'price_desc' %}active{% endif %}"
                               href="?{% url_replace q=query sort='price_desc' %}">
                                Цена: по убыванию
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item {% if request.GET.sort == 'newest' %}active{% endif %}"
                               href="?{% url_replace q=query sort='newest' %}">
                                Новинки
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            {% if products.exists %}
                <div class="row" id="product-grid" itemprop="mainContentOfPage">
                    {% for product in products %}
                        <div class="col-md-4 mb-4">
                            {% include 'products/includes/product_card.html' with product=product highlight=query %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Пагинация -->
                {% include 'products/includes/pagination.html' %}
            {% else %}
                <div class="text-center py-5">
                    <p>По запросу <strong>"{{ query }}"</strong> ничего не найдено.</p>
                    <a href="{% url 'product_list' %}" class="btn btn-primary">Вернуться в каталог</a>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Подсветка совпадений
        document.querySelectorAll('.product-card').forEach(card => {
            const text = card.innerText;
            const regex = new RegExp('{{ query }}', 'gi');
            card.innerHTML = text.replace(regex, match =>
                `<span class="search-highlight">${match}</span>`
            );
        });
    </script>
{% endblock %}